- やったこと
    - 自分のプロダクト「face Destiny」初めのログイン部分作成でJWTを使った実装をしたかったので、JWTについて調べた。
    - middlrewareをクリーンアーキテクチャのどこに実装すべきかを考えた。
        - middlewareって抽象化すべきなのか？
    - jwtの実装


- 最初の状態
なんとなくJWTを使えば、サーバー側からユーザー側に認証における情報を保持でき、サーバーはそのJWTが改ざんされていないかどうかを見ればいいので、サーバー側の負荷が減るメリットとしてあるのがJWTだと思った。

- 何につまづいたのか・分からなかったのか
しかし、
- どういうプロセスでログインがされ、そこでJWTが生成され検証されるのか
- JWTの中身は？なぜ改ざんを検知できるのか？
がまだ明確にわかっていないことが分かった。

- なぜ詰まったのか
JWTの表面的な理解をしていたのみだった。またログイン処理をちゃんと作ったことがなかった。
大体ログイン処理なら、
1. メールアドレスとパスワードを入れる
2. サーバー側に入力値が送られる
3. DBに格納されている情報と比較する
4. 合ってたら、ログイン後のページに飛ばす、ダメならエラーを出してそのまま
と軽く思っていたが、きちんと実装してみると
- 「エラー文を詳細にしない」→ 攻撃者に余計な情報を与えない
- 「ミドルウェアを設ける」→ JWTによる検証をするためにクライアントとサーバー側に中間層を設ける
など様々な学びがあった。きちんと手を動かして、自分で考える癖をしていないがために曖昧な理解のまま終わってしまった。

- どう理解に持っていったのか
JWTは、定義、原理から調べて、自分でまとめた。また調べたものを通して実際に自分で実装を行うことで体系的な理解に努めた。

- 今ならどう説明するか
# JWTとは？

JWTとは、JSON形式のデータを、署名によって信頼性を担保した状態でやり取りするための規格のこと。

# JWTの構造

JWTはドット(.)で区切られた3つのパートで構成されている。

- ① ヘッダー：種類とアルゴリズム、署名にはこのアルゴリズムを使っていますというデータの扱い方
- ② ペイロード：中身のデータ、ユーザーID：123」「名前：田中」「有効期限：15時まで」と言った、実際に伝えたい情報が入っている。
    - 注意：ここは、暗号化されているわけではなく、単にエンコードという形式変換されているだけなので、誰でも中身を読めてしまう。なので、パスワードなどの機密情報を入れてはいけない。
- ③ 署名：改ざんチェック用
ヘッダーとペイロードを合わせたものに、サーバーだけが知っている「秘密の鍵」を使って計算した値のこと。
もし誰かがペイロードを1文字でも書き換えると、計算結果(署名)が一致しなくなる。これにより、これは間違いなく私が発行した、改ざんされていないデータだと判定できる。
サーバー側が、受け取ったJWTを見て「途中で書き換えられていないか？」をチェックする。

サーバー側は、JWTの作成とJWTの検証を行う。

### 署名によるチェックの仕組み

1. JWTの発行時 (サーバーの作業)
    1. ヘッダーとペイロードをくっつける
    2. くっつけたものを、サーバーだけが知っている「秘密鍵」を使って、ハッシュ化する。
    3. 出てきたハッシュ化されたものを署名として、JWTの末尾にくっつける。

1. JWTの検証時 (サーバーの作業)
    
    ユーザーからJWTが送られてきた時、サーバーが改ざんされていないか確認する
    
    1. 届いたJWTのヘッダーとペイロードを取り出す。
    2. 手元にある秘密鍵を使って、もう一度計算をする。
    3. 自分で計算した結果と、JWTについている署名を見比べる

そこで、

- 一致した場合、アクセスを許可する
- 一致しない場合、中身が一文字でも書き換えられたかと阪大し、エラーを返す。

書き換えた場合、元の計算結果と一致しなくなるため、これは違うもの(書き換えられたものだ)と判断される。