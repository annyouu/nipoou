# やったこと
- 認証方式をJWTからRedisセッション管理へ移行（クリーンアーキテクチャに基づくリファクタリング）

# 最初の状態
- 今日の面接でCTOと話したが、ログインにJWTを使うのは、サーバーの負荷を減らせるというメリットがあるが、あくまでトークンが署名によって改ざんされているかどうかを見る検証のみをするので、トークンを盗まれてコピーされてしまったら、突破されてしまう。JWT以外で何を使えばこのセキュリティリスクを減らせるか？という問いに他にどんな対策があるかがわからなかった。あくまでJWTを実装すればそれでいいと思ってしまっていた。
- そこからAIと壁打ちして、Redisを利用したセッション方式を採用することで、サーバーレスは失うが、JWTによるセキュリティリスクを解決できることがわかった。

# 何につまづいたのか・分からなかったのか
- まず、JWTにセキュリティリスクがあるなら他にどういう方法があるのかがわからなかった。
- JWT信者になっていて、視野が狭くなっていた。

# なぜ詰まったのか
- セキュリティが攻撃を発生させないという「予防」のイメージが強く。起こってから、そのリスクを最小限にするという「対処」としての考えが欠如していたため、Redisによるセッション管理、もし不正なログインがあったとしても、Redisのデータを消すことによって、不正アクセスに被害を最小限にできるということを理解していなかった。

# どう理解に持っていったのか
1. まずJWTにどういうセキュリティリスクがあるかを確認した。
2. 他にどういう代替手段があるかを確認した。
3. Redisによるセッション管理があることをAIとの壁打ちで知った。
4. Redisを使うとどうリスクを軽減できるかを確認した。
5. 実装手順をAIと壁打ちした。

# 今ならどう説明するか

## JWTとRedisによる比較
1. サーバーによって権利を管理できる
 - JWT：発行した切符は、有効期限が切れるまでサーバー側では止められない。
 - Redis：サーバー側でRedisのデータを消した時、そのユーザーはアクセスできなくなる。「管理者による強制ログアウト」ができるのは強みである。

2. ブラウザ側に機密情報をおかないようにできる
 - JWT：中身 (ユーザーIDや権限)がブラウザから丸見えである。暗号化されていないため。
 - Redis：ブラウザには、session_id: abc-123という意味のないランダムな文字列だけを渡す。本当の情報はサーバーのRedisの中に隠す。

## Redisによってどうリスクを減らせるのか？
Redisの方がセキュリティ的に楽なのは、万が一が起きた時の防御力が段違いだから。

セキュリティは大きく分けて「予防」と「対処」の2つの側面がある

1. セキュリティの「予防」と「対処」
    1. 予防 (トークンを盗ませない)
        1. HttpOnlyやSecure属性、WAFの導入などがこれにあたる。これは「盾」を厚くする作業のこと。
    2. 対処 (盗まれた後に被害を最小化する)
        1. これが今回のRedisの話のこと。どんなに強力な盾を持っていても、100%防ぐことは不可能(デバイスそのものが盗まれたり、OSの脆弱性をつかれたり)
        2. そのもしもが起きた時の対処の速さ、対処のしやすさを考慮した時、リモートで鍵を無効化出来る (Redisから削除する)という手段があるか、ないかがJWTと違ってRedisの素晴らしいところ
        対処をまたは、レジリエンス（回復力）とも呼ぶ。

## Redisについて、不正ログインはどう確認する？
例えば、IPアドレスの場所が変わったなど
1分前まで東京からアクセスしていたのに、急にアメリカからアクセスが来たら「怪しい」と判定し、自動でRedisからそのセッションを消すなどをしたら、不正ログインへの被害を最小限にできる。
